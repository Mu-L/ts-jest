"use strict";(self.webpackChunkts_jest_docs=self.webpackChunkts_jest_docs||[]).push([[106],{248:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"guides/esm-support","title":"ESM Support","description":"ts-jest will take into account of the following things when working with ESM:","source":"@site/docs/guides/esm-support.md","sourceDirName":"guides","slug":"/guides/esm-support","permalink":"/ts-jest/docs/next/guides/esm-support","draft":false,"unlisted":false,"editUrl":"https://github.com/kulshekhar/ts-jest/edit/main/website/docs/guides/esm-support.md","tags":[],"version":"current","lastUpdatedBy":"Philippe Ombredanne","lastUpdatedAt":1743606749000,"frontMatter":{"id":"esm-support","title":"ESM Support"},"sidebar":"docs","previous":{"title":"Version checking","permalink":"/ts-jest/docs/next/getting-started/version-checking"},"next":{"title":"Mock ES6 class","permalink":"/ts-jest/docs/next/guides/mock-es6-class"}}');var o=t(4848),i=t(8453),r=t(4252);const l={id:"esm-support",title:"ESM Support"},c=void 0,d={},a=[{value:"Configure Jest runtime",id:"configure-jest-runtime",level:2},{value:"Configure <code>tsconfig</code>",id:"configure-tsconfig",level:2},{value:"Using ES module values",id:"using-es-module-values",level:3},{value:"Using hybrid module values",id:"using-hybrid-module-values",level:3},{value:"Configure Jest config",id:"configure-jest-config",level:2},{value:"Resolve <code>.mjs/.mts</code> extensions",id:"resolve-mjsmts-extensions",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.admonition,{type:"important",children:[(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"ts-jest"})," will take into account of the following things when working with ESM:"]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://jestjs.io/docs/en/ecmascript-modules",children:"Jest Runtime"})}),"\n",(0,o.jsxs)(n.li,{children:["Check ",(0,o.jsx)(n.code,{children:'type: "module"'})," in ",(0,o.jsx)(n.code,{children:"package.json"})," ",(0,o.jsx)(n.strong,{children:"ONLY WHEN"})," ",(0,o.jsx)(n.code,{children:"module"})," in ",(0,o.jsx)(n.code,{children:"tsconfig"})," has hybrid value: either ",(0,o.jsx)(n.code,{children:"Node16"}),"/",(0,o.jsx)(n.code,{children:"Node18"}),"/",(0,o.jsx)(n.code,{children:"NodeNext"})]}),"\n",(0,o.jsxs)(n.li,{children:["When ",(0,o.jsx)(n.code,{children:"module"})," in ",(0,o.jsx)(n.code,{children:"tsconfig"})," isn't set to a hybrid value, ",(0,o.jsx)(n.code,{children:"module"})," ",(0,o.jsx)(n.strong,{children:"MUST HAVE"})," one of the ES values, e.g. ",(0,o.jsx)(n.code,{children:"ES2015"}),", ",(0,o.jsx)(n.code,{children:"ES2020"})," etc..."]}),"\n"]})]}),"\n",(0,o.jsxs)(n.p,{children:["One can configure ",(0,o.jsx)(n.code,{children:"ts-jest"})," to work with Jest in ESM mode by following the steps below."]}),"\n","\n",(0,o.jsx)(r.A,{toc:a.slice(0)}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"configure-jest-runtime",children:"Configure Jest runtime"}),"\n",(0,o.jsxs)(n.p,{children:["Check ",(0,o.jsx)(n.a,{href:"https://jestjs.io/docs/en/ecmascript-modules",children:"ESM Jest documentation"}),"."]}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsx)(n.p,{children:"Jest runtime currently has a few issues related to support ESM:"}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Not taking into account of ",(0,o.jsx)(n.code,{children:'type: "module"'})," field in ",(0,o.jsx)(n.code,{children:"package.json"})," yet to run as ESM mode."]}),"\n",(0,o.jsxs)(n.li,{children:["Mocking ES modules are not supported yet, track progress here ",(0,o.jsx)(n.a,{href:"https://github.com/jestjs/jest/pull/10976",children:"https://github.com/jestjs/jest/pull/10976"})]}),"\n"]}),(0,o.jsxs)(n.p,{children:["Overall progress and discussion can be found at ",(0,o.jsx)(n.a,{href:"https://github.com/jestjs/jest/issues/9430",children:"https://github.com/jestjs/jest/issues/9430"})]})]}),"\n",(0,o.jsxs)(n.h2,{id:"configure-tsconfig",children:["Configure ",(0,o.jsx)(n.code,{children:"tsconfig"})]}),"\n",(0,o.jsxs)(n.p,{children:["One can choose either of the following options for ",(0,o.jsx)(n.code,{children:"tsconfig"}),":"]}),"\n",(0,o.jsx)(n.h3,{id:"using-es-module-values",children:"Using ES module values"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="tsconfig.spec.json"',children:'{\n  "compilerOptions": {\n    "module": "ESNext", // or any values starting with "es" or "ES"\n    "target": "ESNext",\n    "esModuleInterop": true\n  }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"using-hybrid-module-values",children:"Using hybrid module values"}),"\n",(0,o.jsxs)(n.admonition,{type:"important",children:[(0,o.jsxs)(n.p,{children:["Hybrid module values requires ",(0,o.jsx)(n.code,{children:"type"})," field in ",(0,o.jsx)(n.code,{children:"package.json"})," to be set explicitly to:"]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"commonjs"})," for ",(0,o.jsx)(n.code,{children:"CommonJS"})," code"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"module"})," for ",(0,o.jsx)(n.code,{children:"ESM"})," code"]}),"\n"]}),(0,o.jsxs)(n.p,{children:["See official TypeScript documentation at ",(0,o.jsx)(n.a,{href:"https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-node18-nodenext",children:"https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-node18-nodenext"})]})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="tsconfig.spec.json"',children:'{\n  "compilerOptions": {\n    "module": "Node16", // or Node18/NodeNext\n    "target": "ESNext",\n    "esModuleInterop": true\n  }\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"configure-jest-config",children:"Configure Jest config"}),"\n",(0,o.jsxs)(n.p,{children:["Configure your Jest configuration to use one of the ",(0,o.jsx)(n.a,{href:"/ts-jest/docs/next/getting-started/presets",children:"utility functions"})]}),"\n",(0,o.jsx)(n.p,{children:"For example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="jest.config.ts"',children:"import type { Config } from 'jest'\nimport { createDefaultEsmPreset } from 'ts-jest'\n\nconst presetConfig = createDefaultEsmPreset({\n  //...options\n})\n\nconst jestConfig: Config = {\n  ...presetConfig,\n}\n\nexport default jestConfig\n"})}),"\n",(0,o.jsxs)(n.h2,{id:"resolve-mjsmts-extensions",children:["Resolve ",(0,o.jsx)(n.code,{children:".mjs/.mts"})," extensions"]}),"\n",(0,o.jsxs)(n.p,{children:["To work with ",(0,o.jsx)(n.code,{children:".mts"})," extension, besides the requirement to run Jest and ",(0,o.jsx)(n.code,{children:"ts-jest"})," in ESM mode, there are a few extra requirements to be met:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"package.json"})," should contain ",(0,o.jsx)(n.code,{children:'"type": "module"'})]}),"\n",(0,o.jsxs)(n.li,{children:["A custom Jest resolver to resolve ",(0,o.jsx)(n.code,{children:".mjs"})," extension, for example:"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="custom-resolver.ts"',children:"import type { SyncResolver } from 'jest-resolve'\n\nconst mjsResolver: SyncResolver = (path, options) => {\n  const mjsExtRegex = /\\.mjs$/i\n  const resolver = options.defaultResolver\n  if (mjsExtRegex.test(path)) {\n    try {\n      return resolver(path.replace(mjsExtRegex, '.mts'), options)\n    } catch {\n      // use default resolver\n    }\n  }\n\n  return resolver(path, options)\n}\n\nexport default mjsResolver\n"})}),"\n",(0,o.jsx)(n.p,{children:"and then add this to Jest config:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="jest.config.ts"',children:"import type { Config } from 'jest'\n\nconst config: Config = {\n  //...other options\n  resolver: '<rootDir>/path/to/custom-resolver.ts',\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},4252:(e,n,t)=>{t.d(n,{A:()=>r});t(6540);var s=t(5195);const o={tableOfContentsInline:"tableOfContentsInline_prmo"};var i=t(4848);function r(e){let{toc:n,minHeadingLevel:t,maxHeadingLevel:r}=e;return(0,i.jsx)("div",{className:o.tableOfContentsInline,children:(0,i.jsx)(s.A,{toc:n,minHeadingLevel:t,maxHeadingLevel:r,className:"table-of-contents",linkClassName:null})})}},5195:(e,n,t)=>{t.d(n,{A:()=>j});var s=t(6540),o=t(6342);function i(e){const n=e.map((e=>({...e,parentIndex:-1,children:[]}))),t=Array(7).fill(-1);n.forEach(((e,n)=>{const s=t.slice(2,e.level);e.parentIndex=Math.max(...s),t[e.level]=n}));const s=[];return n.forEach((e=>{const{parentIndex:t,...o}=e;t>=0?n[t].children.push(o):s.push(o)})),s}function r(e){let{toc:n,minHeadingLevel:t,maxHeadingLevel:s}=e;return n.flatMap((e=>{const n=r({toc:e.children,minHeadingLevel:t,maxHeadingLevel:s});return function(e){return e.level>=t&&e.level<=s}(e)?[{...e,children:n}]:n}))}function l(e){const n=e.getBoundingClientRect();return n.top===n.bottom?l(e.parentNode):n}function c(e,n){let{anchorTopOffset:t}=n;const s=e.find((e=>l(e).top>=t));if(s){return function(e){return e.top>0&&e.bottom<window.innerHeight/2}(l(s))?s:e[e.indexOf(s)-1]??null}return e[e.length-1]??null}function d(){const e=(0,s.useRef)(0),{navbar:{hideOnScroll:n}}=(0,o.p)();return(0,s.useEffect)((()=>{e.current=n?0:document.querySelector(".navbar").clientHeight}),[n]),e}function a(e){const n=(0,s.useRef)(void 0),t=d();(0,s.useEffect)((()=>{if(!e)return()=>{};const{linkClassName:s,linkActiveClassName:o,minHeadingLevel:i,maxHeadingLevel:r}=e;function l(){const e=function(e){return Array.from(document.getElementsByClassName(e))}(s),l=function(e){let{minHeadingLevel:n,maxHeadingLevel:t}=e;const s=[];for(let o=n;o<=t;o+=1)s.push(`h${o}.anchor`);return Array.from(document.querySelectorAll(s.join()))}({minHeadingLevel:i,maxHeadingLevel:r}),d=c(l,{anchorTopOffset:t.current}),a=e.find((e=>d&&d.id===function(e){return decodeURIComponent(e.href.substring(e.href.indexOf("#")+1))}(e)));e.forEach((e=>{!function(e,t){t?(n.current&&n.current!==e&&n.current.classList.remove(o),e.classList.add(o),n.current=e):e.classList.remove(o)}(e,e===a)}))}return document.addEventListener("scroll",l),document.addEventListener("resize",l),l(),()=>{document.removeEventListener("scroll",l),document.removeEventListener("resize",l)}}),[e,t])}var u=t(8774),h=t(4848);function m(e){let{toc:n,className:t,linkClassName:s,isChild:o}=e;return n.length?(0,h.jsx)("ul",{className:o?void 0:t,children:n.map((e=>(0,h.jsxs)("li",{children:[(0,h.jsx)(u.A,{to:`#${e.id}`,className:s??void 0,dangerouslySetInnerHTML:{__html:e.value}}),(0,h.jsx)(m,{isChild:!0,toc:e.children,className:t,linkClassName:s})]},e.id)))}):null}const p=s.memo(m);function j(e){let{toc:n,className:t="table-of-contents table-of-contents__left-border",linkClassName:l="table-of-contents__link",linkActiveClassName:c,minHeadingLevel:d,maxHeadingLevel:u,...m}=e;const j=(0,o.p)(),f=d??j.tableOfContents.minHeadingLevel,g=u??j.tableOfContents.maxHeadingLevel,x=function(e){let{toc:n,minHeadingLevel:t,maxHeadingLevel:o}=e;return(0,s.useMemo)((()=>r({toc:i(n),minHeadingLevel:t,maxHeadingLevel:o})),[n,t,o])}({toc:n,minHeadingLevel:f,maxHeadingLevel:g});return a((0,s.useMemo)((()=>{if(l&&c)return{linkClassName:l,linkActiveClassName:c,minHeadingLevel:f,maxHeadingLevel:g}}),[l,c,f,g])),(0,h.jsx)(p,{toc:x,className:t,linkClassName:l,...m})}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var s=t(6540);const o={},i=s.createContext(o);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);